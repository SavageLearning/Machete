@model Machete.Domain.WorkOrder
@using Machete.Web.Helpers
@using Machete.Web.Resources
@using Machete.Service

@{
    System.Globalization.CultureInfo CI = (System.Globalization.CultureInfo)Session["Culture"];
    string recType = "WO";
    string empRecType = "employer";
    string idPrefix = recType + Model.ID + "-";
    string empPrefix = empRecType + Model.EmployerID + "-";
    int editDisable = 0;
    if (!Html.IsInRole(Html.Role_H()))
    {
        editDisable = 1;
    }
}
@using (Html.BeginForm("Edit", "HirerWorkOrder", FormMethod.Post,
                        new { @class = "edittab-form EditPost", @id = "WorkOrderTab-" + Model.ID }))
{
    //
    // Phonedesk can save changes if work order is today or in the future
    if ((Html.IsInRole(Html.Role_AMP()) && Model.dateTimeofWork >= DateTime.Today) || Html.IsInRole(Html.Role_AM()))
    {
    <input type="submit" value="@WorkOrders.editsubmit" class="formButton saveBtn" id="@(idPrefix)SaveBtn"/>
    }

    if (Html.IsInRole(Html.Role_AM()))
    {
        <input id="deleteWorkOrderButton-@(Model.ID)" type="button" value="@WorkOrders.deletesubmit" class="formButton deleteButton" />
    }
    <br />  
    @Html.ValidationSummary(true)
    @Html.Partial("HirerWorkOrderEdit", Model)

}

@if (Html.IsInRole(Html.Role_AM()))
{
    using (Html.BeginForm("Delete", "HirerWorkOrder", FormMethod.Post,
                            new { @class = "edittab-form DeletePost", @id = "DeleteWorkOrder-" + Model.ID }))
    {
        @Html.HiddenFor(model => model.ID);
    }
}

<div id="@(idPrefix)emailPopup" />

<script type="text/javascript">
    $(document).ready(function () {
        var eDis = @editDisable; //ignore visual studio error; moved assignment here so it would parse the rest
        if ( eDis == 1 ) { 
            $('#WorkOrderTab-@(Model.ID)').find('input,select,textarea').attr('disabled', 'disabled');
        }
        $('.formButton').button();
        $('#contactName').focus();        

        // English note toggle
        $('#@(idPrefix)englishRequired').mUI('selectToggleOnValue', {
            target: $('#@(idPrefix)englishRequiredNoteRow'),
            showVal: "@(Shared.yes)"
        });

        // machete UI detect changes on forms in tabs   
        $("#WorkOrderTab-@(Model.ID)").mUI('formDetectChanges', {
            recType: "@(recType)",
            formLevel: 2,
            changeConfirm: "@(Machete.Web.Resources.Shared.changeConfirm)",
            changeTitle: "@(Machete.Web.Resources.Shared.changeTitle)"
        });

        // Add validation to dynamic content
        $.validator.unobtrusive.parseDynamicContent($('#WorkOrderTab-@Model.ID'));

        // Find tabindex attribute (for tab order, not jquery tabs) and increment by 10
        $('#WorkOrderTab-@Model.ID').find('[tabindex]').each(function () { 
            $(this).attr('tabindex', parseInt($(this).attr('tabindex')) + 10) 
        });

        // open work order view for printing
        $('#viewWorkOrder-@(Model.ID)').click(function () {
            window.open('/WorkOrder/View/@(Model.ID)');
        });

        // Delete confirmation 
        $("#deleteWorkOrderButton-@(Model.ID)").mUI('formClickDelete', {
            ok: "@WorkOrders.deletesubmit",
            confirm: '@WorkOrders.deleteconfirmation',
            title: '@WorkOrders.deletetitle',
            form: $('#DeleteWorkOrder-@Model.ID')
        });

        // submit edit
        $("#WorkOrderTab-@(Model.ID)").mUI('tabFormSubmit', {
            exclusiveTab: false,
            selectTab: 0,
            preProcess: function () {
                $('#workerRequests2_WO-@(Model.ID)').find('option').attr("selected", "selected");
            },
            formLevel: 2
        });
    });
</script>