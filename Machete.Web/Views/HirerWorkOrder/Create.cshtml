@model Machete.Domain.WorkOrder
@using Machete.Web.Resources
@{
    System.Globalization.CultureInfo CI = (System.Globalization.CultureInfo)Session["Culture"];
    string recType = "WO";
    string empRecType = "employer";
    string idPrefix = recType + Model.ID + "-";
    string empPrefix = empRecType + Model.EmployerID + "-";
}

@using (Html.BeginForm("Create", "HirerWorkOrder", FormMethod.Post, 
                        new { @id = "workOrderCreateForm" }))
{
    @Html.ValidationSummary(true, @Machete.Web.Resources.ValidationStrings.HirerWOCreateValSummary)
    @Html.Partial("HirerWorkOrderEdit", Model)
    <input type="submit" id="@(idPrefix)SaveBtn" class="formButton saveBtn"
        value="@WorkOrders.submit" tabindex="41" />
}
    
<script type="text/javascript">
    $(document).ready(function () {

        alert("Testing JQuery II");

        var woCreateForm = $('#workOrderCreateForm');
        $('.formButton').button();

        // machete UI detect changes on forms in tabs   
        woCreateForm.mUI('formDetectChanges', {
            recType: "@(recType)",
            formLevel: 2,
            changeConfirm: "@(Machete.Web.Resources.Shared.changeConfirm)",
            changeTitle: "@(Machete.Web.Resources.Shared.changeTitle)"
        });

        // Add validation to dynamic content
        $.validator.unobtrusive.parseDynamicContent('#workOrderCreateForm');

        // WorkOrder Create submit event
        woCreateForm.mUI('tabFormSubmit', {
            create: true,
            exclusivetab: false,
            recType: "@(recType)",
            preProcess: function () {
                $('#workerRequests2_WO-@(Model.ID)').find('option').attr("selected", "selected");
                $('#workAssignments_WO-@(Model.ID)').find('option').attr("selected", "selected");
            },
            postProcess: function () {
                $('html, body').animate({ scrollTop: $(document).height() }, 'slow');
            },
            formLevel: 2
        });

        // Note: this code was causing JQuery not to load when placed in HirerWorkOrderEdit.cshtml
        // TODO: investigate why!?
        function checkTransportationMethodDate() {
            if ($("#@(idPrefix)transportMethodID").val() == "") {
                return;
            }

            // Note: this is logic that is specific to Casa Latina only
            var workerCenter = @System.Web.Configuration.WebConfigurationManager.AppSettings["OrganizationName"];
            if (workerCenter != "Casa Latina") {
                $("#invalidTransportDate").hide();
                return;
            }

            var userInput = $("#@(idPrefix)dateTimeofWork").val();
            var userInputInMs = new Date(userInput);

            if (isNaN(userInputInMs.valueOf())) {
                $("#invalidDate").text("The date must be in a valid date form (e.g. 03/14/2015 14:00)").show();
                return;
            } else {
                $("#invalidDate").hide();
            }

            var dayOfWeek = userInputInMs.getDay();

            if (dayOfWeek == 0) { // Sunday
                // Note: only valid transportation method on Sunday is Pickup
                // TODO: this value is hard-coded, should be replaced
                if ((transportMethod == 26) || (transportMethod == 29)) { // Worker buses = 26
                    $("#invalidTransportDate").text("Workers can only be picked up for work on Sunday").show();
                } else {
                    $("#invalidTransportDate").hide();
                }
            }

        };


    });
</script>
