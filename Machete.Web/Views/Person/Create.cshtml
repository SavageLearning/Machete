@model Machete.Domain.Person
@using Machete.Web.Resources
@{  
    string recType = "person";
    string idPrefix = recType + Model.ID + "-";
}
@using (Html.BeginForm("Create", "Person", FormMethod.Post, 
    new { @id = "personCreateForm" }))
{
    @Html.AntiForgeryToken()
    <input type="button" onclick="FindPersonDuplicate()" id="@(idPrefix)SaveBtn" class="formButton saveBtn" 
            value="@Persons.createsubmit" tabindex="9"/>
    @Html.ValidationSummary(true)
    @Html.EditorForModel()
}

<div id="messageDialog" title="Warning">
    <p id="messageDialogText">Already found a person with same name, last name and phone number. Do you still want to save?</p>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        var personCreateForm = $('#personCreateForm');
        $('.formButton').button();
        $.validator.unobtrusive.parseDynamicContent(personCreateForm);
        $('#firstname1').focus();
        //
        //
        personCreateForm.mUI('tabFormSubmit', {
            recType: "@(recType)", //for add_rectab
            create: true,
            formLevel: 1
        });
        //
        // machete UI detect changes on forms in tabs   
        personCreateForm.mUI('formDetectChanges', {
            recType: "@(recType)",
            formLevel: 1,
            changeConfirm: "@(Machete.Web.Resources.Shared.changeConfirm)",
            changeTitle: "@(Machete.Web.Resources.Shared.changeTitle)"
        });
    });

    var messageDialog = $("#messageDialog").dialog({
        autoOpen: false,
        height: 200,
        width: 300,
        modal: true,
        closeOnEscape: false,
        buttons: {
            "Save":     function () { $(this).dialog("close"); savePerson(); },
            "Cancel": function () { $(this).dialog("close"); }
        }
    });


    function FindPersonDuplicate() {
        $.ajax({
            url: "/Person/GetDuplicates",
            data: {
                firstname: $('#person0-firstname1')[0].value,
                lastname: $('#person0-lastname1')[0].value,
                phone: $('#person0-phone')[0].value
            }, 
            success: onSuccessFindPersonDuplicate,
            dataType: "json"
        });
    }

    function onSuccessFindPersonDuplicate(result) {
        if (result.isDuplicate) {
            messageDialog.dialog("open");
        }
        else {
            savePerson();
        }
    }

    function savePerson() {
        $("#personCreateForm").submit();
    }
</script>